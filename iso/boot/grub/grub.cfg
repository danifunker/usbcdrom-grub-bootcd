# GRUB2 Boot Configuration - SuperGRUB-inspired with diagnostics
# Optimized for IDE-connected drives in BIOS systems

# Basic configuration
set timeout=10
set default=0

# Limit disk scan to prevent "disk not found" errors
set GRUB_DISABLE_DISK_SCAN=true

# Start by loading essential modules
insmod part_msdos
insmod fat
insmod iso9660
insmod normal

# First try CD devices (most reliable for CD boot)
if [ -d (cd0)/boot/grub ]; then
  set root=cd0
  set prefix=(cd0)/boot/grub
elif [ -d (cd1)/boot/grub ]; then
  set root=cd1
  set prefix=(cd1)/boot/grub
# Then try ATA devices (for IDE connections)
elif [ -d (ata0)/boot/grub ]; then
  set root=ata0
  set prefix=(ata0)/boot/grub
elif [ -d (ata1)/boot/grub ]; then
  set root=ata1
  set prefix=(ata1)/boot/grub
elif [ -d (ata2)/boot/grub ]; then
  set root=ata2
  set prefix=(ata2)/boot/grub
# Finally try by label
elif search --no-floppy --label USBHLPCD --set=root; then
  set prefix=(${root})/boot/grub
fi

# Set image directory
set image_dir=($root)/images

# Load menu display capability
insmod normal
normal

# Diagnostic menu entry with comprehensive system information
menuentry "Diagnostic Tools and System Information" {
  echo "=== GRUB VARIABLES ==="
  echo "Root: ${root}"
  echo "Prefix: ${prefix}"
  echo "Image dir: ${image_dir}"
  echo ""
  
  echo "=== AVAILABLE DEVICES ==="
  ls
  echo ""
  
  echo "=== FILE STRUCTURE ==="
  echo "Root directory:"
  ls /
  echo "Boot directory:"
  ls /boot || echo "No boot directory found"
  echo "GRUB directory:"
  ls /boot/grub || echo "No grub directory found"
  echo "Images directory:"
  ls /images || echo "No images directory found"
  echo ""
  
  echo "=== IDE/PATA DEVICES ==="
  ls (ata0) || echo "No device at ata0"
  ls (ata1) || echo "No device at ata1"
  ls (ata2) || echo "No device at ata2"
  echo ""
  
  echo "=== CD DEVICES ==="
  ls (cd) || echo "No generic CD device found"
  ls (cd0) || echo "No device at cd0"
  ls (cd1) || echo "No device at cd1"
  echo ""
  
  echo "=== USB DEVICES ==="
  ls (usb) || echo "No generic USB device found"
  ls (usb0) || echo "No device at usb0"
  ls (usb1) || echo "No device at usb1"
  echo ""
  
  echo "Press any key to return to menu"
  sleep -i 30
}

menuentry "Boot USB CD-ROM" {
  echo "Loading memdisk and USB CD-ROM..."
  linux16 /boot/memdisk iso raw
  initrd16 (usb0)
}

menuentry "Boot Windows 98 with USB CDROM Support" {
  echo "Loading Windows 98 boot image..."
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 with USB CDROM" {
  echo "Loading MS-DOS 6.22 image..."
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

menuentry "Boot from first hard disk" {
  echo "Booting from first hard disk..."
  chainloader (hd0)+1
}
