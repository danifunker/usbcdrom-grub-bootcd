# SuperGrub-inspired boot configuration
# Initial setup to ensure prefix is set correctly

# This line is critical - it forces loading core.img with proper prefix
if [ -z "${prefix}" ]; then
  # Only run this if prefix isn't set yet
  if [ -f ${cmdpath}/grub.cfg ]; then
    # We can find our path from the command path
    prefix=${cmdpath}
  else
    # Try to find our device by filesystem label
    search --no-floppy --label "USBHLPCD" --set=root
    prefix=(${root})/boot/grub
  fi
fi

# Ensure root is set if we only have prefix
if [ -z "${root}" ]; then
  root=${prefix%/*/*/*}
fi

# Basic configuration
set timeout=10
set default=0

# Add some visual styling
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Now that prefix is properly set, load modules
insmod all_video
insmod gfxterm
insmod part_msdos
insmod fat
insmod iso9660
insmod usb
insmod uhci
insmod ohci
insmod ehci
insmod usbms

# RESCUE MODE COMPATIBLE CONFIGURATION
# Set basic variables immediately to prevent "prefix isn't set" errors
set prefix=(cd0)/boot/grub
set root=cd0

# Limit disk scan to prevent "disk not found" errors
set bios_boot=1

# Try to find our device by filesystem label (fallback method)
search --no-floppy --label "USBHLPCD" --set=found_root
if [ -n "$found_root" ]; then
  set root=$found_root
  set prefix=($found_root)/boot/grub
fi

# Basic configuration
set timeout=10
set default=0

# Add some visual styling
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Load necessary modules with proper error handling
insmod part_msdos || true
insmod fat || true
insmod iso9660 || true
insmod usb || true
insmod uhci || true
insmod usbms || true

# Only try these if core modules loaded successfully
if [ -e ${prefix}/normal.mod ]; then
  insmod all_video
  insmod gfxterm
  insmod ohci
  insmod ehci
fi

# Diagnostic menu entry to help troubleshoot
menuentry "List Devices and Files" {
  echo "Available devices:"
  ls
  echo "Files in root:"
  ls /
  echo "Boot directory:"
  ls /boot
  echo "GRUB directory:"
  ls /boot/grub
  echo "Prefix: ${prefix}"
  echo "Root: ${root}"
  echo "Press ESC to return to menu"
  sleep 30
}

menuentry "Boot USB CD-ROM" {
  linux16 /boot/memdisk iso raw
  initrd16 (usb0)
}

menuentry "Boot from Windows 98 Floppy Image with USB CDROM Support" {
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 Basic Floppy Image (no setup.bat)" {
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

# Add a fallback option
menuentry "Boot from first hard disk" {
  insmod chain || true
  insmod part_gpt || true
  chainloader (hd0,1)+1
}

