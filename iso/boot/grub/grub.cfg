# GRUB2 Boot Configuration - Extreme disk scanning prevention
# Specifically designed to avoid disk scanning errors

# Load early config settings (replaces --early-config)
if [ -f /boot/grub/early_config.cfg ]; then
  source /boot/grub/early_config.cfg
fi

# CRITICAL: Immediately override cmdpath if it contains problematic values
if regexp 'hd[2-9][0-9]' "${cmdpath}"; then
  echo "Fixing problematic cmdpath: ${cmdpath}"
  set cmdpath=""
fi

# Load essential modules first
insmod part_msdos
insmod fat
insmod iso9660
insmod normal

# Disable disk scanning with multiple techniques
set GRUB_DISABLE_DISK_SCAN=true
function grub_probe { true; }
export grub_probe

# CRITICAL: Limit disk discovery to only what we know exists
function ls { set save_func_ls="$@"; cat; }
function cat { echo "ls: ${save_func_ls}"; }
if [ "${save_func_ls}" = "(hd31)" ]; then 
  echo "Blocked scan of hd31"; 
  return 0; 
fi
export ls
export cat

# Set static values - don't rely on cmdpath which could be problematic
set root=cd0
set prefix=(cd0)/boot/grub
set image_dir=(cd0)/images

# Basic configuration
set timeout=10
set default=0

# Load menu display capability
normal

menuentry "Diagnostic Tools" {
  echo "=== GRUB VARIABLES ==="
  echo "Root: ${root}"
  echo "Prefix: ${prefix}"
  echo "Image dir: ${image_dir}"
  echo "cmdpath: ${cmdpath}"
  echo ""
  
  echo "=== AVAILABLE DEVICES ==="
  # Use a simplified device list to avoid full scanning
  echo "(cd) (cd0) (hd0)"
  echo ""
  
  echo "=== FILE STRUCTURE ==="
  echo "Root directory:"
  ls /
  echo "Boot directory:"
  ls /boot || true
  echo ""
  
  echo "Press any key to continue..."
  sleep -i 30
}

menuentry "Boot Windows 98 with USB CDROM Support" {
  echo "Loading Windows 98 boot image..."
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 with USB CDROM" {
  echo "Loading MS-DOS 6.22 image..."
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

menuentry "Boot from first hard disk" {
  echo "Booting from first hard disk..."
  chainloader (hd0)+1
}
