# GRUB2 Boot Configuration - SuperGRUB-inspired with diagnostics
# Optimized for IDE-connected drives in BIOS systems

# Basic configuration
set timeout=10
set default=0

# CRITICAL FIX: Explicitly disable device probing beyond what's needed
set GRUB_DISABLE_DISK_SCAN=true
probe -u hd1 || true

# Start by loading essential modules
insmod ata
insmod part_msdos
insmod fat
insmod iso9660
insmod normal

# Simplified device detection - only check what's likely to exist
# Check CD devices first (for CD boot)
if [ -e (cd0) ]; then
  echo "Found CD device at cd0"
  set root=cd0
  set prefix=(cd0)/boot/grub
# Finally try by label
elif search --no-floppy --label USBHLPCD --set=root; then
  echo "Found device with label USBHLPCD"
  set prefix=(${root})/boot/grub
fi

# Set image directory
set image_dir=($root)/images

# Load menu display capability - this time with error handling
insmod normal || echo "Failed to load normal module"
normal || echo "Failed to execute normal module"

# Start simple menu entry if normal fails
menuentry "Diagnostic Tools" {
  echo "=== GRUB VARIABLES ==="
  echo "Root: ${root}"
  echo "Prefix: ${prefix}"
  echo "Image dir: ${image_dir}"
  echo ""
  
  echo "=== AVAILABLE DEVICES ==="
  ls
  echo ""
  
  echo "=== FILE STRUCTURE ==="
  echo "Root directory:"
  ls /
  echo "Boot directory:"
  ls /boot || echo "No boot directory found"
  echo ""
  
  echo "Press any key to continue..."
  sleep -i 30
}

menuentry "Boot Windows 98 with USB CDROM Support" {
  echo "Loading Windows 98 boot image..."
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 with USB CDROM" {
  echo "Loading MS-DOS 6.22 image..."
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

menuentry "Boot from first hard disk" {
  echo "Booting from first hard disk..."
  chainloader (hd0)+1
}
