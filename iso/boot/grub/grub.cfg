# GRUB2 Boot Configuration for USBHLPCD
# Optimized for IDE-connected drives in BIOS systems

# Set fallback variables immediately
set prefix=(cd0)/boot/grub
set root=cd0

# Try to find our device by filesystem label with IDE-friendly hints
search --no-floppy --label USBHLPCD --set=found_root --hint-bios=cd0 --hint=cd0 --hint-bios=hd0 --hint=hd0

# Apply the search results if found
if [ -n "$found_root" ]; then
  set root=$found_root
  set prefix=($found_root)/boot/grub
fi

# Basic configuration (only once)
set timeout=10
set default=0

# Add some visual styling
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Limit disk scan to prevent "disk not found" errors
set bios_boot=1

# Load necessary modules with proper error handling for IDE systems
insmod ata || true
insmod part_msdos || true
insmod fat || true
insmod iso9660 || true
insmod usb || true
insmod uhci || true
insmod usbms || true

# Only try these if core modules loaded successfully
if [ -e ${prefix}/normal.mod ]; then
  insmod all_video
  insmod gfxterm
  insmod ohci
  insmod ehci
fi

# Diagnostic menu entry to help troubleshoot
menuentry "List Devices and Files" {
  echo "Available devices:"
  ls
  echo "Files in root:"
  ls /
  echo "Boot directory:"
  ls /boot
  echo "GRUB directory:"
  ls /boot/grub
  echo "Prefix: ${prefix}"
  echo "Root: ${root}"
  echo "IDE info:"
  ls (hd0) || echo "No IDE drive found at hd0"
  ls (hd1) || echo "No IDE drive found at hd1"
  echo "Press ESC to return to menu"
  sleep 30
}

menuentry "Boot USB CD-ROM" {
  linux16 /boot/memdisk iso raw
  initrd16 (usb0)
}

menuentry "Boot from Windows 98 Floppy Image with USB CDROM Support" {
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 Basic Floppy Image (no setup.bat)" {
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

# Add a fallback option for IDE primary drive
menuentry "Boot from first IDE hard disk" {
  insmod chain || true
  insmod part_msdos || true
  chainloader (hd0)+1
}

