# SuperGrub-inspired boot configuration
# Initial setup to ensure prefix is set correctly

# This line is critical - it forces loading core.img with proper prefix
if [ -z "${prefix}" ]; then
  # Only run this if prefix isn't set yet
  if [ -f ${cmdpath}/grub.cfg ]; then
    # We can find our path from the command path
    prefix=${cmdpath}
  else
    # Try to find our device by filesystem label
    search --no-floppy --label "USBHLPCD" --set=root
    prefix=(${root})/boot/grub
  fi
fi

# Ensure root is set if we only have prefix
if [ -z "${root}" ]; then
  root=${prefix%/*/*/*}
fi

# Basic configuration
set timeout=10
set default=0

# Add some visual styling
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Now that prefix is properly set, load modules
insmod all_video
insmod gfxterm
insmod part_msdos
insmod fat
insmod iso9660
insmod usb
insmod uhci
insmod ohci
insmod ehci
insmod usbms

# Diagnostic menu entry to help troubleshoot
menuentry "List Devices and Files" {
  echo "Available devices:"
  ls
  echo "Files in root:"
  ls /
  echo "Boot directory:"
  ls /boot
  echo "GRUB directory:"
  ls /boot/grub
  echo "Prefix: ${prefix}"
  echo "Root: ${root}"
  echo "Command path: ${cmdpath}"
  echo "Press ESC to return to menu"
  sleep 30
}

menuentry "Boot USB CD-ROM" {
  linux16 /boot/memdisk iso raw
  initrd16 (usb0)
}

menuentry "Boot from Windows 98 Floppy Image with USB CDROM Support" {
  # Boot from the floppy image
  linux16 /boot/memdisk
  initrd16 /images/w98_boot.img
}

menuentry "Boot MSDOS 6.22 Basic Floppy Image (no setup.bat)" {
  # Boot from the floppy image
  linux16 /boot/memdisk
  initrd16 /images/msdos622-with-usbcdrom.img
}

# Add a fallback option
menuentry "Boot from first hard disk" {
  insmod chain
  insmod part_gpt
  chainloader (hd0,1)+1
}

